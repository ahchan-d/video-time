<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>iOS Video Debug</title>
<style>
/* ãƒšãƒ¼ã‚¸æ‹¡å¤§ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒã‚¦ãƒ³ã‚¹ãƒ»ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é˜²æ­¢ */
html, body {
  overflow: hidden;
  overscroll-behavior: none;
  -webkit-overflow-scrolling: auto;
  touch-action: none;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
  position: fixed;
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒŠ */
#container {
  width: 100%;
  height: 100%;
  overflow-y: auto;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
  touch-action: pan-y;
  padding: 16px;
  box-sizing: border-box;
}

body { font-family: system-ui; }

/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯é¸æŠå¯èƒ½ã« */
#log, #timeDisplay { -webkit-user-select: text; user-select: text; }
video { width: 100%; max-height: 50vh; background: #333; }
button { font-size: 18px; padding: 12px 16px; margin: 4px; }
#log { background: #f0f0f0; padding: 10px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }

/* ã‚·ãƒ¼ã‚¯ãƒãƒ¼ */
#seekContainer { margin: 16px 0; }
#seekBar { width: 100%; height: 8px; cursor: pointer; }
#timeDisplay { font-family: monospace; font-size: 16px; margin: 8px 0; }
#fineSeek { margin: 8px 0; }
#fineSeek button { font-size: 14px; padding: 8px 12px; }
#timestampBtn { background: #4CAF50; color: white; border: none; border-radius: 4px; }
#timestampBtn:active { background: #388E3C; }
.copied { background: #2196F3 !important; }

/* ãƒœã‚¿ãƒ³ã®ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ é˜²æ­¢ */
button, input { touch-action: manipulation; }
</style>
</head>
<body>
<div id="container">

<h3>iOS Video Debug</h3>

<div id="log">Loading...</div>

<p><input type="file" id="file" accept="video/*"></p>

<video id="video" controls playsinline muted webkit-playsinline></video>

<!-- ã‚·ãƒ¼ã‚¯ãƒãƒ¼ãƒ»ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— -->
<div id="seekContainer">
  <input type="range" id="seekBar" min="0" max="100" step="0.01" value="0">
  <div id="timeDisplay">00:00.000 / 00:00.000</div>
  <div id="fineSeek">
    <button id="seekBack10">-10s</button>
    <button id="seekBack1">-1s</button>
    <button id="seekBackFrame">-0.1s</button>
    <button id="seekFwdFrame">+0.1s</button>
    <button id="seekFwd1">+1s</button>
    <button id="seekFwd10">+10s</button>
  </div>
  <p>
    <button id="timestampBtn">ğŸ“‹ ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚³ãƒ”ãƒ¼</button>
    <span id="copyFeedback"></span>
  </p>
</div>

<p>
<button id="btnPlay">â–¶ Play</button>
<button id="btnPause">â¸ Pause</button>
</p>

<script>
// ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ é˜²æ­¢
document.addEventListener("touchstart", function(e) {
  if (e.touches.length > 1) e.preventDefault();
}, { passive: false });

document.addEventListener("gesturestart", function(e) {
  e.preventDefault();
}, { passive: false });

// ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é˜²æ­¢
var container = document.getElementById("container");
var lastY = 0;

container.addEventListener("touchstart", function(e) {
  lastY = e.touches[0].clientY;
}, { passive: true });

container.addEventListener("touchmove", function(e) {
  var y = e.touches[0].clientY;
  var scrollTop = container.scrollTop;

  // ä¸Šç«¯ã§ä¸‹ã«å¼•ã£å¼µã£ãŸæ™‚ã®ã¿ãƒ–ãƒ­ãƒƒã‚¯
  if (scrollTop <= 0 && y > lastY) {
    e.preventDefault();
  }
  lastY = y;
}, { passive: false });

// ãƒ­ã‚°é–¢æ•°
var logEl = document.getElementById("log");
function log(msg) {
  var now = new Date().toLocaleTimeString();
  logEl.textContent = now + " " + msg + "\n" + logEl.textContent;
}

// èµ·å‹•ç¢ºèª
log("Script loaded. UA: " + navigator.userAgent.slice(0, 50));

var v = document.getElementById("video");
var fileInput = document.getElementById("file");

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
fileInput.onchange = function(e) {
  log("File input changed");

  var files = e.target.files;
  log("Files count: " + (files ? files.length : "null"));

  if (!files || files.length === 0) {
    log("No file selected");
    return;
  }

  var f = files[0];
  log("File: " + f.name);
  log("Size: " + f.size + " bytes");
  log("Type: " + f.type);

  // Blob URLæ–¹å¼
  try {
    var url = URL.createObjectURL(f);
    log("Blob URL created: " + url.slice(0, 30) + "...");
    v.src = url;
    log("src set");
  } catch(err) {
    log("ERROR: " + err.message);
  }
};

// Video events
v.onloadstart = function() { log("EVENT: loadstart"); };
v.onloadedmetadata = function() { log("EVENT: loadedmetadata, duration=" + v.duration); };
v.onloadeddata = function() { log("EVENT: loadeddata"); };
v.oncanplay = function() { log("EVENT: canplay"); };
v.onerror = function() {
  var e = v.error;
  log("EVENT: error - " + (e ? "code=" + e.code + " " + e.message : "unknown"));
};
v.onplaying = function() { log("EVENT: playing"); };
v.onstalled = function() { log("EVENT: stalled"); };
v.onsuspend = function() { log("EVENT: suspend"); };

// ãƒœã‚¿ãƒ³
document.getElementById("btnPlay").onclick = function() {
  log("Play button clicked");
  v.play().then(function() {
    log("Play succeeded");
    v.muted = false;
  }).catch(function(e) {
    log("Play failed: " + e.message);
  });
};

document.getElementById("btnPause").onclick = function() {
  log("Pause clicked");
  v.pause();
};

// ã‚·ãƒ¼ã‚¯ãƒãƒ¼é–¢é€£
var seekBar = document.getElementById("seekBar");
var timeDisplay = document.getElementById("timeDisplay");

function formatTime(sec) {
  if (isNaN(sec) || !isFinite(sec)) return "00:00.000";
  var m = Math.floor(sec / 60);
  var s = sec % 60;
  return String(m).padStart(2, "0") + ":" + s.toFixed(3).padStart(6, "0");
}

function updateTimeDisplay() {
  var current = formatTime(v.currentTime);
  var total = formatTime(v.duration);
  timeDisplay.textContent = current + " / " + total;

  if (v.duration > 0) {
    seekBar.value = (v.currentTime / v.duration) * 100;
  }
}

v.ontimeupdate = function() {
  updateTimeDisplay();
};

v.ondurationchange = function() {
  updateTimeDisplay();
  log("Duration: " + v.duration);
};

// ã‚·ãƒ¼ã‚¯ãƒãƒ¼æ“ä½œ
seekBar.oninput = function() {
  if (v.duration > 0) {
    v.currentTime = (seekBar.value / 100) * v.duration;
    updateTimeDisplay();
  }
};

// ç´°ã‹ã„ã‚·ãƒ¼ã‚¯ãƒœã‚¿ãƒ³
function seekBy(sec) {
  v.currentTime = Math.max(0, Math.min(v.duration || 0, v.currentTime + sec));
  updateTimeDisplay();
  log("Seek to: " + formatTime(v.currentTime));
}

document.getElementById("seekBack10").onclick = function() { seekBy(-10); };
document.getElementById("seekBack1").onclick = function() { seekBy(-1); };
document.getElementById("seekBackFrame").onclick = function() { seekBy(-0.1); };
document.getElementById("seekFwdFrame").onclick = function() { seekBy(0.1); };
document.getElementById("seekFwd1").onclick = function() { seekBy(1); };
document.getElementById("seekFwd10").onclick = function() { seekBy(10); };

// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚³ãƒ”ãƒ¼
document.getElementById("timestampBtn").onclick = function() {
  var timestamp = formatTime(v.currentTime);
  var btn = document.getElementById("timestampBtn");
  var feedback = document.getElementById("copyFeedback");

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(timestamp).then(function() {
      log("Copied: " + timestamp);
      btn.classList.add("copied");
      feedback.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: " + timestamp;
      setTimeout(function() {
        btn.classList.remove("copied");
        feedback.textContent = "";
      }, 2000);
    }).catch(function(err) {
      log("Copy failed: " + err.message);
      fallbackCopy(timestamp);
    });
  } else {
    fallbackCopy(timestamp);
  }
};

function fallbackCopy(text) {
  var ta = document.createElement("textarea");
  ta.value = text;
  ta.style.position = "fixed";
  ta.style.opacity = "0";
  document.body.appendChild(ta);
  ta.select();
  try {
    document.execCommand("copy");
    log("Copied (fallback): " + text);
    document.getElementById("copyFeedback").textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: " + text;
  } catch(e) {
    log("Copy failed: " + e.message);
    document.getElementById("copyFeedback").textContent = "ã‚³ãƒ”ãƒ¼å¤±æ•—";
  }
  document.body.removeChild(ta);
  setTimeout(function() {
    document.getElementById("copyFeedback").textContent = "";
  }, 2000);
}

log("Setup complete");
</script>

</div>
</body>
</html>
