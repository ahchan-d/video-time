<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Video Annotation Tool</title>
<style>
/* ãƒ†ãƒ¼ãƒå¤‰æ•° */
:root {
  --bg-color: #ffffff;
  --bg-secondary: #f5f5f5;
  --bg-tertiary: #e0e0e0;
  --text-color: #333333;
  --text-secondary: #666666;
  --border-color: #dddddd;
  --input-bg: #ffffff;
  --input-border: #cccccc;
  --table-hover: #f0f0f0;
  --table-header: #e0e0e0;
  --suggestion-hover: #e3f2fd;
  --editing-row: #fff3e0;
  --video-bg: #333333;
}

[data-theme="dark"] {
  --bg-color: #1a1a1a;
  --bg-secondary: #2d2d2d;
  --bg-tertiary: #404040;
  --text-color: #e0e0e0;
  --text-secondary: #a0a0a0;
  --border-color: #444444;
  --input-bg: #333333;
  --input-border: #555555;
  --table-hover: #3a3a3a;
  --table-header: #404040;
  --suggestion-hover: #1e3a5f;
  --editing-row: #4a3a2a;
  --video-bg: #000000;
}

/* ãƒšãƒ¼ã‚¸æ‹¡å¤§ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒã‚¦ãƒ³ã‚¹ãƒ»ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é˜²æ­¢ */
html, body {
  overflow: hidden;
  overscroll-behavior: none;
  -webkit-overflow-scrolling: auto;
  touch-action: none;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
  position: fixed;
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  background: var(--bg-color);
  color: var(--text-color);
  transition: background 0.3s, color 0.3s;
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒŠ */
#container {
  width: 100%;
  height: 100%;
  overflow-y: auto;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
  touch-action: pan-y;
  padding: 16px;
  box-sizing: border-box;
  background: var(--bg-color);
}

body { font-family: system-ui; }

/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯é¸æŠå¯èƒ½ã« */
#timeDisplay, input, textarea, td { -webkit-user-select: text; user-select: text; }
video { width: 100%; max-height: 40vh; background: var(--video-bg); }
button { font-size: 16px; padding: 10px 14px; margin: 4px; cursor: pointer; }

/* ã‚·ãƒ¼ã‚¯ãƒãƒ¼ */
#seekContainer { margin: 12px 0; }
#seekBar { width: 100%; height: 8px; cursor: pointer; }
#timeDisplay { font-family: monospace; font-size: 16px; margin: 8px 0; }
#playbackControls { margin: 8px 0; display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
#playbackControls button { font-size: 14px; padding: 8px 12px; }
#speedDisplay { font-family: monospace; font-size: 14px; min-width: 40px; text-align: center; }
#fineSeek { margin: 8px 0; display: flex; flex-wrap: nowrap; gap: 4px; }
#fineSeek button { font-size: 12px; padding: 6px 8px; flex-shrink: 0; }
#volumeControls { margin: 8px 0; display: flex; align-items: center; gap: 8px; }
#volumeControls button { font-size: 14px; padding: 8px 12px; }
#volumeBar { width: 150px; height: 8px; cursor: pointer; }
#volumeDisplay { font-family: monospace; font-size: 14px; min-width: 50px; }
#timestampBtn { background: #4CAF50; color: white; border: none; border-radius: 4px; }
#timestampBtn:active { background: #388E3C; }
.copied { background: #2196F3 !important; }

/* ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰ */
#fineModeBtn { background: #9E9E9E; color: white; border: none; border-radius: 4px; }
#fineModeBtn.active { background: #FF5722; }
#fineModeInfo { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
#fineModeInfo.active { color: #FF5722; font-weight: bold; }

/* ãƒœã‚¿ãƒ³ã®ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ é˜²æ­¢ */
button, input { touch-action: manipulation; }

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.section { margin: 16px 0; padding: 12px; background: var(--bg-secondary); border-radius: 8px; transition: background 0.3s; }
.section h4 { margin: 0 0 12px 0; color: var(--text-color); }
h3 { color: var(--text-color); }

/* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› */
input[type="file"] {
  color: var(--text-color);
}

/* ãƒ¬ãƒ³ã‚¸å…¥åŠ›ï¼ˆã‚·ãƒ¼ã‚¯ãƒãƒ¼ã€éŸ³é‡ãƒãƒ¼ï¼‰ */
input[type="range"] {
  accent-color: #2196F3;
}

/* ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« */
#annotationTable { width: 100%; border-collapse: collapse; font-size: 14px; }
#annotationTable th, #annotationTable td { border: 1px solid var(--border-color); padding: 8px; text-align: left; color: var(--text-color); }
#annotationTable th { background: var(--table-header); }
#annotationTable tr:hover { background: var(--table-hover); }
#annotationTable .query-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
#tableContainer { max-height: 300px; overflow-y: auto; }

/* ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  */
#editForm { display: grid; gap: 8px; }
#editForm label { font-weight: bold; font-size: 14px; color: var(--text-color); }
#editForm input, #editForm textarea, #editForm select {
  font-size: 16px;
  padding: 8px;
  border: 1px solid var(--input-border);
  border-radius: 4px;
  width: 100%;
  box-sizing: border-box;
  background: var(--input-bg);
  color: var(--text-color);
  transition: background 0.3s, border-color 0.3s, color 0.3s;
}
#editForm textarea { resize: vertical; min-height: 60px; }

/* ã‚ªãƒ¼ãƒˆã‚µã‚¸ã‚§ã‚¹ãƒˆ */
.query-input-container { position: relative; }

/* ã‚¤ãƒ³ã‚µãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
.insert-mode-indicator {
  font-size: 11px;
  font-weight: normal;
  color: var(--text-secondary);
  margin-left: 8px;
  padding: 2px 8px;
  border-radius: 4px;
  background: var(--bg-tertiary);
}

.insert-mode-indicator.active {
  background: #4CAF50;
  color: white;
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}
#suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--input-bg);
  border: 1px solid var(--input-border);
  border-top: none;
  border-radius: 0 0 4px 4px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 100;
  display: none;
}
#suggestions.show { display: block; }
.suggestion-item {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid var(--border-color);
  font-size: 14px;
  color: var(--text-color);
}
.suggestion-item:hover, .suggestion-item.selected {
  background: var(--suggestion-hover);
}
.suggestion-item:last-child { border-bottom: none; }
.form-row { display: flex; align-items: center; gap: 8px; }
.form-row input { flex: 1; }
.form-row button { flex-shrink: 0; }

/* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
.btn-primary { background: #2196F3; color: white; border: none; border-radius: 4px; }
.btn-primary:active { background: #1976D2; }
.btn-danger { background: #f44336; color: white; border: none; border-radius: 4px; }
.btn-danger:active { background: #d32f2f; }
.btn-secondary { background: #9E9E9E; color: white; border: none; border-radius: 4px; }
.btn-small { font-size: 12px; padding: 6px 10px; }

/* ç·¨é›†ä¸­ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
#annotationTable tr.editing { background: var(--editing-row) !important; }

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
#status { font-size: 14px; color: var(--text-secondary); margin: 8px 0; }
#status.error { color: #f44336; }
#status.success { color: #4CAF50; }

/* è‡ªå‹•ä¿å­˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
#autoSaveStatus {
  font-size: 13px;
  padding: 8px 12px;
  border-radius: 4px;
  margin: 8px 0;
  display: none;
}
#autoSaveStatus.active {
  display: block;
  background: #e8f5e9;
  color: #2e7d32;
  border: 1px solid #a5d6a7;
}
[data-theme="dark"] #autoSaveStatus.active {
  background: #1b3d1f;
  color: #81c784;
  border-color: #2e5a32;
}

/* è‡ªå‹•ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
#autoSaveIndicator {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #4CAF50;
  color: white;
  padding: 10px 16px;
  border-radius: 8px;
  font-size: 14px;
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.3s, transform 0.3s;
  z-index: 1000;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
#autoSaveIndicator.show {
  opacity: 1;
  transform: translateY(0);
}

/* ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒãƒ¢ãƒ¼ãƒ€ãƒ« */
.backup-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.6);
  z-index: 3000;
  align-items: center;
  justify-content: center;
}

.backup-modal.show {
  display: flex;
}

.backup-modal-content {
  background: var(--bg-color);
  border-radius: 12px;
  padding: 24px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.backup-modal-content h4 {
  margin: 0 0 12px 0;
  font-size: 18px;
}

.backup-modal-content p {
  margin: 8px 0;
}

/* ã‚¿ã‚¤ãƒãƒ¼ãƒ‘ãƒãƒ« */
.timer-panel {
  background: var(--bg-secondary);
  border-radius: 8px;
  padding: 12px 16px;
  margin: 16px 0;
  border: 2px solid var(--border-color);
}

.timer-panel.running {
  border-color: #4CAF50;
  background: linear-gradient(135deg, var(--bg-secondary), rgba(76, 175, 80, 0.1));
}

.timer-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.timer-header h4 {
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.timer-display {
  font-family: monospace;
  font-size: 32px;
  font-weight: bold;
  text-align: center;
  padding: 12px;
  background: var(--bg-color);
  border-radius: 8px;
  margin-bottom: 12px;
}

.timer-display.running {
  color: #4CAF50;
}

.timer-controls {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.timer-controls button {
  flex: 1;
  padding: 10px;
  font-size: 14px;
}

.timer-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  text-align: center;
}

.timer-stat {
  background: var(--bg-color);
  padding: 10px 8px;
  border-radius: 6px;
}

.timer-stat-value {
  font-size: 20px;
  font-weight: bold;
  color: #2196F3;
}

.timer-stat-label {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 4px;
}

.timer-avg {
  margin-top: 12px;
  padding: 12px;
  background: linear-gradient(135deg, #2196F3, #1976D2);
  color: white;
  border-radius: 8px;
  text-align: center;
}

.timer-avg-value {
  font-size: 24px;
  font-weight: bold;
}

.timer-avg-label {
  font-size: 12px;
  opacity: 0.9;
}

/* ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
.theme-toggle-container {
  position: fixed;
  top: 16px;
  right: 16px;
  z-index: 1000;
}

.theme-toggle {
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  padding: 8px 16px;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text-color);
  transition: background 0.3s, border-color 0.3s;
}

.theme-toggle:hover {
  background: var(--table-hover);
}

.theme-toggle .icon {
  font-size: 16px;
}

/* PCç”¨2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
@media (min-width: 1024px) {
  #container {
    max-width: 1800px;
    margin: 0 auto;
  }

  .main-grid {
    display: flex;
    align-items: stretch;
    gap: 0;
  }

  .left-column, .right-column {
    display: flex;
    flex-direction: column;
    gap: 16px;
    min-width: 300px;
    overflow: hidden;
  }

  .left-column {
    flex: 1 1 50%;
  }

  .right-column {
    flex: 1 1 50%;
  }

  .section {
    margin: 0;
  }

  video {
    max-height: none;
    width: 100%;
  }

  #tableContainer {
    max-height: 400px;
  }

  /* ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« */
  .resize-handle {
    width: 8px;
    background: var(--border-color);
    cursor: col-resize;
    flex-shrink: 0;
    position: relative;
    transition: background 0.2s;
    margin: 0 4px;
    border-radius: 4px;
  }

  .resize-handle:hover,
  .resize-handle.dragging {
    background: #2196F3;
  }

  .resize-handle::after {
    content: "â‹®";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--text-secondary);
    font-size: 14px;
  }

  .resize-handle:hover::after,
  .resize-handle.dragging::after {
    color: white;
  }
}

/* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«éè¡¨ç¤º */
@media (max-width: 1023px) {
  .resize-handle {
    display: none;
  }
}

/* ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒ˜ãƒ«ãƒ— */
.shortcut-help-btn {
  position: fixed;
  bottom: 20px;
  left: 20px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  font-size: 18px;
  cursor: pointer;
  z-index: 1000;
  color: var(--text-color);
  display: flex;
  align-items: center;
  justify-content: center;
}

.shortcut-help-btn:hover {
  background: var(--table-hover);
}

.shortcut-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 2000;
  align-items: center;
  justify-content: center;
}

.shortcut-modal.show {
  display: flex;
}

.shortcut-content {
  background: var(--bg-color);
  border-radius: 12px;
  padding: 24px;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.shortcut-content h3 {
  margin-top: 0;
  margin-bottom: 16px;
}

.shortcut-section {
  margin-bottom: 16px;
}

.shortcut-section h4 {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: var(--text-secondary);
}

.shortcut-item {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px solid var(--border-color);
}

.shortcut-item:last-child {
  border-bottom: none;
}

.shortcut-key {
  background: var(--bg-tertiary);
  padding: 2px 8px;
  border-radius: 4px;
  font-family: monospace;
  font-size: 13px;
}

.shortcut-close {
  position: absolute;
  top: 10px;
  right: 10px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--text-color);
}

/* ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰è¡¨ç¤ºï¼ˆãƒœã‚¿ãƒ³æ¨ªï¼‰ */
.key-hint {
  font-size: 13px;
  font-weight: bold;
  color: #000000;
  margin-left: 6px;
  background: #f0f0f0;
  padding: 2px 8px;
  border-radius: 4px;
  border: 1px solid #999;
}

[data-theme="dark"] .key-hint {
  color: #ffffff;
  background: #444;
  border-color: #666;
}

@media (max-width: 1023px) {
  .key-hint {
    display: none;
  }
  .shortcut-help-btn {
    display: none;
  }
  #volumeControls {
    display: none;
  }
}
</style>
</head>
<body>
<div class="theme-toggle-container">
  <button class="theme-toggle" id="themeToggle">
    <span class="icon" id="themeIcon">ğŸŒ™</span>
    <span id="themeText">ãƒ€ãƒ¼ã‚¯</span>
  </button>
</div>

<div id="container">

<h3>Video Annotation Tool</h3>

<div class="main-grid" id="mainGrid">
<div class="left-column" id="leftColumn">

<!-- å‹•ç”»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="section">
  <h4>å‹•ç”»</h4>
  <p><input type="file" id="file" accept="video/*"><span class="key-hint" style="margin-left: 8px;">[O]</span></p>
  <video id="video" playsinline muted webkit-playsinline></video>

  <div id="seekContainer">
    <input type="range" id="seekBar" min="0" max="100" step="0.01" value="0">
    <div id="timeDisplay">00:00.000 / 00:00.000</div>
    <div id="playbackControls">
      <button id="btnRewind" class="btn-secondary" title="R">âª<span class="key-hint">[R]</span></button>
      <button id="btnPlayPause" class="btn-primary" title="Space">â–¶<span class="key-hint">[Space]</span></button>
      <button id="btnFastFwd" class="btn-secondary" title="F">â©<span class="key-hint">[F]</span></button>
      <span id="speedDisplay">1.0x</span>
    </div>
    <div id="fineSeek">
      <button id="seekBack10" title="J">-10s<span class="key-hint">[J]</span></button>
      <button id="seekBack1" title="â†">-1s<span class="key-hint">[â†]</span></button>
      <button id="seekBackFrame" title=",">-0.1s<span class="key-hint">[,]</span></button>
      <button id="seekFwdFrame" title=".">+0.1s<span class="key-hint">[.]</span></button>
      <button id="seekFwd1" title="â†’">+1s<span class="key-hint">[â†’]</span></button>
      <button id="seekFwd10" title="L">+10s<span class="key-hint">[L]</span></button>
    </div>
    <div id="volumeControls">
      <button id="muteBtn" title="M">ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ<span class="key-hint">[M]</span></button>
      <input type="range" id="volumeBar" min="0" max="300" value="100">
      <span id="volumeDisplay">100%</span>
      <span class="key-hint">[â†‘â†“]</span>
      <span id="boostIndicator" style="display: none; color: #ff9800; font-weight: bold; font-size: 12px;">ğŸ”Š BOOST</span>
    </div>
    <p>
      <button id="fineModeBtn" title="P">ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰<span class="key-hint">[P]</span></button>
      <button id="timestampBtn" title="C">ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚³ãƒ”ãƒ¼<span class="key-hint">[C]</span></button>
      <span id="copyFeedback"></span>
    </p>
    <div id="fineModeInfo">ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰: ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã®å‹•ããŒ10å€ç´°ã‹ããªã‚Šã¾ã™</div>
  </div>
</div>

<!-- CSVãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ -->
<div class="section">
  <h4>CSVãƒ•ã‚¡ã‚¤ãƒ«</h4>
  <p>
    <button id="loadCsvBtn" class="btn-primary">CSVã‚’èª­ã¿è¾¼ã¿</button>
    <button id="openLocalCsvBtn" class="btn-primary">ãƒ­ãƒ¼ã‚«ãƒ«CSVã‚’é–‹ã</button>
    <button id="downloadCsvBtn" class="btn-primary">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <button id="saveCsvBtn" class="btn-primary" disabled>ä¸Šæ›¸ãä¿å­˜</button>
    <button id="restoreFromBackupBtn" class="btn-secondary">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒ</button>
  </p>
  <div id="autoSaveStatus"></div>
  <div id="backupStatus" style="display: none; font-size: 12px; color: var(--text-secondary);"></div>
  <div id="status"></div>
  <div id="autoSaveIndicator">âœ“ è‡ªå‹•ä¿å­˜å®Œäº†</div>
</div>

<!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="backup-modal" id="backupModal">
  <div class="backup-modal-content">
    <h4>ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</h4>
    <p id="backupInfo"></p>
    <p style="font-size: 13px; color: var(--text-secondary);">å‰å›ã®ä½œæ¥­ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ</p>
    <div style="display: flex; gap: 8px; margin-top: 16px;">
      <button id="restoreBackupBtn" class="btn-primary" style="flex: 1;">å¾©å…ƒã™ã‚‹</button>
      <button id="ignoreBackupBtn" class="btn-secondary" style="flex: 1;">ç„¡è¦–ã™ã‚‹</button>
    </div>
  </div>
</div>

</div><!-- /left-column -->

<div class="resize-handle" id="resizeHandle"></div>

<div class="right-column" id="rightColumn">

<!-- ã‚¿ã‚¤ãƒãƒ¼ãƒ‘ãƒãƒ« -->
<div class="timer-panel" id="timerPanel">
  <div class="timer-header">
    <h4>â±ï¸ ä½œæ¥­ã‚¿ã‚¤ãƒãƒ¼</h4>
    <button id="timerResetBtn" class="btn-secondary btn-small" title="Y">ãƒªã‚»ãƒƒãƒˆ<span class="key-hint">[Y]</span></button>
  </div>
  <div class="timer-display" id="timerDisplay">00:00:00</div>
  <div class="timer-controls">
    <button id="timerStartBtn" class="btn-primary" title="T">â–¶ é–‹å§‹<span class="key-hint">[T]</span></button>
    <button id="timerStopBtn" class="btn-secondary" disabled title="T">â¸ åœæ­¢<span class="key-hint">[T]</span></button>
  </div>
  <div class="timer-stats">
    <div class="timer-stat">
      <div class="timer-stat-value" id="timerCount">0</div>
      <div class="timer-stat-label">è¿½åŠ æ•°</div>
    </div>
    <div class="timer-stat">
      <div class="timer-stat-value" id="timerTotalTime">00:00</div>
      <div class="timer-stat-label">çµŒéæ™‚é–“</div>
    </div>
    <div class="timer-stat">
      <div class="timer-stat-value" id="timerRate">-</div>
      <div class="timer-stat-label">ä»¶/æ™‚</div>
    </div>
  </div>
  <div class="timer-avg" id="timerAvgPanel" style="display: none;">
    <div class="timer-avg-label">1ä»¶ã‚ãŸã‚Šã®å¹³å‡æ™‚é–“</div>
    <div class="timer-avg-value" id="timerAvg">--:--</div>
  </div>
</div>

<!-- ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="section">
  <h4 id="formTitle">æ–°è¦ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</h4>
  <div id="editForm">
    <input type="hidden" id="editId" value="">
    <div>
      <label>video_id</label>
      <input type="text" id="editVideoId" readonly style="background: var(--bg-tertiary);">
    </div>
    <div>
      <label>start</label>
      <div class="form-row">
        <input type="number" id="editStart" step="0.1" placeholder="0.0">
        <button type="button" id="setStartBtn" class="btn-secondary btn-small" title="S">ç¾åœ¨æ™‚åˆ»<span class="key-hint">[S]</span></button>
      </div>
    </div>
    <div>
      <label>end</label>
      <div class="form-row">
        <input type="number" id="editEnd" step="0.1" placeholder="0.0">
        <button type="button" id="setEndBtn" class="btn-secondary btn-small" title="E">ç¾åœ¨æ™‚åˆ»<span class="key-hint">[E]</span></button>
      </div>
    </div>
    <div class="query-input-container">
      <label>query <span id="insertModeIndicator" class="insert-mode-indicator">[I] ã§å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</span></label>
      <textarea id="editQuery" placeholder="The nurse performs..."></textarea>
      <div id="suggestions"></div>
      <div style="margin-top: 6px;">
        <button type="button" id="pasteBtn" class="btn-secondary btn-small" title="V">ğŸ“‹ ãƒšãƒ¼ã‚¹ãƒˆ<span class="key-hint">[V]</span></button>
      </div>
    </div>
    <div>
      <button id="saveBtn" class="btn-primary" title="Enter">è¿½åŠ <span class="key-hint">[Enter]</span></button>
      <button id="clearFormBtn" class="btn-secondary">ã‚¯ãƒªã‚¢</button>
    </div>
  </div>
</div>

<!-- ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ -->
<div class="section">
  <h4>ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ (<span id="annotationCount">0</span>ä»¶)</h4>
  <div id="tableContainer">
    <table id="annotationTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>video_id</th>
          <th>start</th>
          <th>end</th>
          <th>query</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="annotationBody">
      </tbody>
    </table>
  </div>
</div>

</div><!-- /right-column -->
</div><!-- /main-grid -->

<!-- ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ -->
<button class="shortcut-help-btn" id="shortcutHelpBtn" title="ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ">âŒ¨</button>

<!-- ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="shortcut-modal" id="shortcutModal">
  <div class="shortcut-content">
    <h3>âŒ¨ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h3>
    <div class="shortcut-section">
      <h4>å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h4>
      <div class="shortcut-item"><span>å†ç”Ÿ/ä¸€æ™‚åœæ­¢</span><span class="shortcut-key">Space</span></div>
      <div class="shortcut-item"><span>å·»ãæˆ»ã—</span><span class="shortcut-key">R</span></div>
      <div class="shortcut-item"><span>æ—©é€ã‚Š</span><span class="shortcut-key">F</span></div>
      <div class="shortcut-item"><span>ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ</span><span class="shortcut-key">M</span></div>
      <div class="shortcut-item"><span>éŸ³é‡+10%</span><span class="shortcut-key">â†‘ / ]</span></div>
      <div class="shortcut-item"><span>éŸ³é‡-10%</span><span class="shortcut-key">â†“ / [</span></div>
    </div>
    <div class="shortcut-section">
      <h4>ã‚·ãƒ¼ã‚¯</h4>
      <div class="shortcut-item"><span>-10ç§’ / +10ç§’</span><span class="shortcut-key">J / L</span></div>
      <div class="shortcut-item"><span>-1ç§’ / +1ç§’</span><span class="shortcut-key">â† / â†’</span></div>
      <div class="shortcut-item"><span>-0.1ç§’ / +0.1ç§’</span><span class="shortcut-key">, / .</span></div>
    </div>
    <div class="shortcut-section">
      <h4>ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</h4>
      <div class="shortcut-item"><span>Startæ™‚åˆ»ã‚’ã‚»ãƒƒãƒˆ</span><span class="shortcut-key">S</span></div>
      <div class="shortcut-item"><span>Endæ™‚åˆ»ã‚’ã‚»ãƒƒãƒˆ</span><span class="shortcut-key">E</span></div>
      <div class="shortcut-item"><span>è¿½åŠ /æ›´æ–°</span><span class="shortcut-key">Enter</span></div>
      <div class="shortcut-item"><span>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚³ãƒ”ãƒ¼</span><span class="shortcut-key">C</span></div>
      <div class="shortcut-item"><span>ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ</span><span class="shortcut-key">P</span></div>
    </div>
    <div class="shortcut-section">
      <h4>ã‚¯ã‚¨ãƒªå…¥åŠ›</h4>
      <div class="shortcut-item"><span>å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</span><span class="shortcut-key">I</span></div>
      <div class="shortcut-item"><span>å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰çµ‚äº†</span><span class="shortcut-key">Esc</span></div>
      <div class="shortcut-item"><span>ãƒšãƒ¼ã‚¹ãƒˆ</span><span class="shortcut-key">V</span></div>
    </div>
    <div class="shortcut-section">
      <h4>ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ã‚¿ã‚¤ãƒãƒ¼</h4>
      <div class="shortcut-item"><span>å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</span><span class="shortcut-key">O</span></div>
      <div class="shortcut-item"><span>ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹/åœæ­¢</span><span class="shortcut-key">T</span></div>
      <div class="shortcut-item"><span>ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ</span><span class="shortcut-key">Y</span></div>
      <div class="shortcut-item"><span>æ‰‹å‹•ä¿å­˜</span><span class="shortcut-key">Ctrl+S</span></div>
    </div>
    <p style="text-align: center; margin-top: 16px; color: var(--text-secondary); font-size: 12px;">
      â€» å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã¯ç„¡åŠ¹
    </p>
    <button class="btn-secondary" style="width: 100%; margin-top: 8px;" onclick="document.getElementById('shortcutModal').classList.remove('show')">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
// ===== ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ =====
(function() {
  var savedTheme = localStorage.getItem("theme");
  var prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
  var theme = savedTheme || (prefersDark ? "dark" : "light");
  document.documentElement.setAttribute("data-theme", theme);
})();

function toggleTheme() {
  var html = document.documentElement;
  var currentTheme = html.getAttribute("data-theme");
  var newTheme = currentTheme === "dark" ? "light" : "dark";
  html.setAttribute("data-theme", newTheme);
  localStorage.setItem("theme", newTheme);
  updateThemeButton(newTheme);
}

function updateThemeButton(theme) {
  var icon = document.getElementById("themeIcon");
  var text = document.getElementById("themeText");
  if (theme === "dark") {
    icon.textContent = "â˜€ï¸";
    text.textContent = "ãƒ©ã‚¤ãƒˆ";
  } else {
    icon.textContent = "ğŸŒ™";
    text.textContent = "ãƒ€ãƒ¼ã‚¯";
  }
}

document.addEventListener("DOMContentLoaded", function() {
  var themeBtn = document.getElementById("themeToggle");
  themeBtn.onclick = toggleTheme;
  var currentTheme = document.documentElement.getAttribute("data-theme");
  updateThemeButton(currentTheme);
});

// ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
var annotations = [];
var editingId = null;
var currentVideoId = "";
var csvFileHandle = null; // File System Access APIç”¨

// ===== DOMè¦ç´  =====
var v = document.getElementById("video");
var fileInput = document.getElementById("file");
var seekBar = document.getElementById("seekBar");
var timeDisplay = document.getElementById("timeDisplay");

// ===== ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ é˜²æ­¢ =====
document.addEventListener("touchstart", function(e) {
  // videoè¦ç´ å†…ã®ãƒãƒ«ãƒã‚¿ãƒƒãƒã¯è¨±å¯ï¼ˆãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ãªã©ï¼‰
  if (e.target.tagName === "VIDEO" || e.target.closest("video")) {
    return;
  }
  if (e.touches.length > 1) e.preventDefault();
}, { passive: false });

document.addEventListener("gesturestart", function(e) {
  // videoè¦ç´ å†…ã®ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã¯è¨±å¯
  if (e.target.tagName === "VIDEO" || e.target.closest("video")) {
    return;
  }
  e.preventDefault();
}, { passive: false });

// ===== ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é˜²æ­¢ =====
var container = document.getElementById("container");
var lastY = 0;

container.addEventListener("touchstart", function(e) {
  lastY = e.touches[0].clientY;
}, { passive: true });

container.addEventListener("touchmove", function(e) {
  // videoè¦ç´ ã‚„ãã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å†…ã®ã‚¿ãƒƒãƒã¯ç„¡è¦–
  var target = e.target;
  if (target.tagName === "VIDEO" || target.closest("video")) {
    return;
  }

  var y = e.touches[0].clientY;
  var scrollTop = container.scrollTop;
  if (scrollTop <= 0 && y > lastY) {
    e.preventDefault();
  }
  lastY = y;
}, { passive: false });

// ===== å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ =====
fileInput.onchange = function(e) {
  var files = e.target.files;
  if (!files || files.length === 0) return;
  var url = URL.createObjectURL(files[0]);
  v.src = url;

  // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰video_idã‚’æŠ½å‡ºï¼ˆæ‹¡å¼µå­ã‚’é™¤ãï¼‰
  var filename = files[0].name;
  currentVideoId = filename.replace(/\.[^.]+$/, "");
  document.getElementById("editVideoId").value = currentVideoId;

  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã—ã¦Spaceã‚­ãƒ¼ã§ã™ãå†ç”Ÿã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
  fileInput.blur();
};

// ===== æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ =====
function formatTime(sec) {
  if (isNaN(sec) || !isFinite(sec)) return "0.000";
  return sec.toFixed(3);
}

function formatTimeForCopy(sec) {
  if (isNaN(sec) || !isFinite(sec)) return "0.0";
  return sec.toFixed(1);
}

// ===== ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰ =====
var fineMode = false;
var fineStartTime = 0;
var fineStartValue = 0;
var fineSensitivity = 10;

function updateTimeDisplay() {
  var current = formatTime(v.currentTime);
  var total = formatTime(v.duration);
  timeDisplay.textContent = current + " / " + total;
  if (v.duration > 0) {
    seekBar.value = (v.currentTime / v.duration) * 100;
  }
}

v.ontimeupdate = updateTimeDisplay;
v.ondurationchange = updateTimeDisplay;

// ===== ã‚·ãƒ¼ã‚¯ãƒãƒ¼æ“ä½œ =====
seekBar.addEventListener("touchstart", function() {
  if (fineMode && v.duration > 0) {
    fineStartTime = v.currentTime;
    fineStartValue = parseFloat(seekBar.value);
  }
});

seekBar.addEventListener("mousedown", function() {
  if (fineMode && v.duration > 0) {
    fineStartTime = v.currentTime;
    fineStartValue = parseFloat(seekBar.value);
  }
});

seekBar.oninput = function() {
  if (v.duration > 0) {
    if (fineMode) {
      var delta = (parseFloat(seekBar.value) - fineStartValue) / fineSensitivity;
      var newPercent = (fineStartTime / v.duration) * 100 + delta;
      newPercent = Math.max(0, Math.min(100, newPercent));
      v.currentTime = (newPercent / 100) * v.duration;
    } else {
      v.currentTime = (seekBar.value / 100) * v.duration;
    }
    updateTimeDisplay();
  }
};

// ===== ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ =====
document.getElementById("fineModeBtn").onclick = function() {
  fineMode = !fineMode;
  var btn = document.getElementById("fineModeBtn");
  var info = document.getElementById("fineModeInfo");
  if (fineMode) {
    btn.classList.add("active");
    btn.textContent = "ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰ ON";
    info.classList.add("active");
    info.textContent = "ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰ ON: ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã®å‹•ããŒ10å€ç´°ã‹ããªã‚Šã¾ã™";
  } else {
    btn.classList.remove("active");
    btn.textContent = "ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰";
    info.classList.remove("active");
    info.textContent = "ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰: ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã®å‹•ããŒ10å€ç´°ã‹ããªã‚Šã¾ã™";
  }
};

// ===== ç´°ã‹ã„ã‚·ãƒ¼ã‚¯ãƒœã‚¿ãƒ³ =====
function seekBy(sec) {
  v.currentTime = Math.max(0, Math.min(v.duration || 0, v.currentTime + sec));
  updateTimeDisplay();
}

document.getElementById("seekBack10").onclick = function() { seekBy(-10); };
document.getElementById("seekBack1").onclick = function() { seekBy(-1); };
document.getElementById("seekBackFrame").onclick = function() { seekBy(-0.1); };
document.getElementById("seekFwdFrame").onclick = function() { seekBy(0.1); };
document.getElementById("seekFwd1").onclick = function() { seekBy(1); };
document.getElementById("seekFwd10").onclick = function() { seekBy(10); };

// ===== éŸ³é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆãƒ–ãƒ¼ã‚¹ãƒˆå¯¾å¿œï¼‰ =====
var volumeBar = document.getElementById("volumeBar");
var volumeDisplay = document.getElementById("volumeDisplay");
var muteBtn = document.getElementById("muteBtn");
var boostIndicator = document.getElementById("boostIndicator");

// Web Audio API for volume boost
var audioContext = null;
var gainNode = null;
var audioSource = null;
var currentVolume = 100; // 0-300%

function initAudioBoost() {
  if (audioContext) return; // Already initialized

  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    gainNode = audioContext.createGain();
    audioSource = audioContext.createMediaElementSource(v);
    audioSource.connect(gainNode);
    gainNode.connect(audioContext.destination);
    applyVolume(currentVolume);
  } catch (err) {
    console.error("Web Audio APIåˆæœŸåŒ–å¤±æ•—:", err);
  }
}

function applyVolume(percent) {
  currentVolume = percent;

  if (percent <= 100) {
    // é€šå¸¸ç¯„å›²: videoã®volumeã§åˆ¶å¾¡
    v.volume = percent / 100;
    if (gainNode) gainNode.gain.value = 1;
    boostIndicator.style.display = "none";
  } else {
    // ãƒ–ãƒ¼ã‚¹ãƒˆç¯„å›²: videoã¯100%ã€gainNodeã§å¢—å¹…
    v.volume = 1;
    if (gainNode) {
      gainNode.gain.value = percent / 100;
    }
    boostIndicator.style.display = "inline";
  }
}

function updateVolumeDisplay() {
  volumeBar.value = currentVolume;
  volumeDisplay.textContent = currentVolume + "%";

  if (v.muted || currentVolume === 0) {
    muteBtn.textContent = "ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ";
    boostIndicator.style.display = "none";
  } else if (currentVolume > 100) {
    muteBtn.textContent = "ğŸ”Š éŸ³ã‚ã‚Š";
    boostIndicator.style.display = "inline";
  } else {
    muteBtn.textContent = "ğŸ”Š éŸ³ã‚ã‚Š";
    boostIndicator.style.display = "none";
  }
}

volumeBar.oninput = function() {
  var vol = parseInt(volumeBar.value);
  v.muted = false;

  // åˆå›æ“ä½œæ™‚ã«AudioContextã‚’åˆæœŸåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ãªãŸã‚ï¼‰
  if (!audioContext && vol > 100) {
    initAudioBoost();
  }

  applyVolume(vol);
  updateVolumeDisplay();
};

muteBtn.onclick = function() {
  if (v.muted) {
    v.muted = false;
    if (currentVolume === 0) {
      currentVolume = 100;
      applyVolume(100);
    }
  } else {
    v.muted = true;
  }
  updateVolumeDisplay();
};

// éŸ³é‡èª¿æ•´é–¢æ•°ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç”¨ï¼‰
function adjustVolume(delta) {
  var newVolume = currentVolume + delta;
  // 0ã€œ300%ã®ç¯„å›²ã«åˆ¶é™
  newVolume = Math.max(0, Math.min(300, newVolume));

  v.muted = false;

  // 100%è¶…ãˆã®å ´åˆã¯AudioContextã‚’åˆæœŸåŒ–
  if (!audioContext && newVolume > 100) {
    initAudioBoost();
  }

  applyVolume(newVolume);
  updateVolumeDisplay();
}

// å‹•ç”»èª­ã¿è¾¼ã¿æ™‚ã«AudioContextã‚’æº–å‚™
v.addEventListener("loadeddata", function() {
  if (currentVolume > 100 && !audioContext) {
    // ãƒ–ãƒ¼ã‚¹ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ãŸã‚‰åˆæœŸåŒ–
    initAudioBoost();
  }
  applyVolume(currentVolume);
  updateVolumeDisplay();
});

// åˆæœŸçŠ¶æ…‹ã§100%éŸ³é‡
currentVolume = 100;
updateVolumeDisplay();

// ===== å†ç”Ÿãƒ»åœæ­¢ãƒ»æ—©é€ã‚Šãƒ»å·»ãæˆ»ã— =====
var speedSteps = [1, 2, 4, 8];
var currentSpeedIndex = 0;
var playbackMode = "normal"; // "normal", "fastfwd", "rewind"
var rewindInterval = null;

function updateSpeedDisplay() {
  var speed = speedSteps[currentSpeedIndex];
  if (playbackMode === "rewind") {
    document.getElementById("speedDisplay").textContent = "â—€â—€ " + speed + "x";
  } else if (playbackMode === "fastfwd") {
    document.getElementById("speedDisplay").textContent = speed + "x â–¶â–¶";
  } else {
    document.getElementById("speedDisplay").textContent = speed + "x";
  }
}

function stopRewind() {
  if (rewindInterval) {
    clearInterval(rewindInterval);
    rewindInterval = null;
  }
}

function resetPlayback() {
  stopRewind();
  playbackMode = "normal";
  currentSpeedIndex = 0;
  v.playbackRate = 1;
  updateSpeedDisplay();
}

document.getElementById("btnPlayPause").onclick = function() {
  resetPlayback();
  if (v.paused) {
    v.play();
  } else {
    v.pause();
  }
};

// å†ç”ŸçŠ¶æ…‹ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
function updatePlayPauseButton() {
  var btn = document.getElementById("btnPlayPause");
  if (v.paused) {
    btn.textContent = "â–¶";
  } else {
    btn.textContent = "â¸";
  }
}

v.onplay = updatePlayPauseButton;
v.onpause = updatePlayPauseButton;
v.onended = updatePlayPauseButton;

document.getElementById("btnFastFwd").onclick = function() {
  stopRewind();

  if (playbackMode === "fastfwd") {
    // æ¬¡ã®é€Ÿåº¦ã¸
    currentSpeedIndex++;
    if (currentSpeedIndex >= speedSteps.length) {
      // æœ€å¾Œã¾ã§è¡Œã£ãŸã‚‰é€šå¸¸ã«æˆ»ã‚‹
      resetPlayback();
      v.play();
      return;
    }
  } else {
    // æ—©é€ã‚Šãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
    playbackMode = "fastfwd";
    currentSpeedIndex = 1; // 2xã‹ã‚‰é–‹å§‹
  }

  v.playbackRate = speedSteps[currentSpeedIndex];
  v.play();
  updateSpeedDisplay();
};

document.getElementById("btnRewind").onclick = function() {
  if (playbackMode === "rewind") {
    // æ¬¡ã®é€Ÿåº¦ã¸
    currentSpeedIndex++;
    if (currentSpeedIndex >= speedSteps.length) {
      // æœ€å¾Œã¾ã§è¡Œã£ãŸã‚‰é€šå¸¸ã«æˆ»ã‚‹
      resetPlayback();
      v.play();
      return;
    }
  } else {
    // å·»ãæˆ»ã—ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
    stopRewind();
    playbackMode = "rewind";
    currentSpeedIndex = 1; // 2xã‹ã‚‰é–‹å§‹
    v.pause();
  }

  // å·»ãæˆ»ã—ã¯intervalã§å®Ÿè£…ï¼ˆè² ã®å†ç”Ÿé€Ÿåº¦ã¯éå¯¾å¿œã®ãŸã‚ï¼‰
  stopRewind();
  var speed = speedSteps[currentSpeedIndex];
  rewindInterval = setInterval(function() {
    v.currentTime = Math.max(0, v.currentTime - (speed * 0.1));
    updateTimeDisplay();
    if (v.currentTime <= 0) {
      resetPlayback();
    }
  }, 100);

  updateSpeedDisplay();
};

// ===== ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚³ãƒ”ãƒ¼ =====
document.getElementById("timestampBtn").onclick = function() {
  var timestamp = formatTimeForCopy(v.currentTime);
  var btn = document.getElementById("timestampBtn");
  var feedback = document.getElementById("copyFeedback");

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(timestamp).then(function() {
      btn.classList.add("copied");
      feedback.textContent = "ã‚³ãƒ”ãƒ¼: " + timestamp;
      setTimeout(function() {
        btn.classList.remove("copied");
        feedback.textContent = "";
      }, 2000);
    }).catch(function(err) {
      fallbackCopy(timestamp);
    });
  } else {
    fallbackCopy(timestamp);
  }
};

function fallbackCopy(text) {
  var ta = document.createElement("textarea");
  ta.value = text;
  ta.style.position = "fixed";
  ta.style.opacity = "0";
  document.body.appendChild(ta);
  ta.select();
  try {
    document.execCommand("copy");
    document.getElementById("copyFeedback").textContent = "ã‚³ãƒ”ãƒ¼: " + text;
  } catch(e) {
    document.getElementById("copyFeedback").textContent = "ã‚³ãƒ”ãƒ¼å¤±æ•—";
  }
  document.body.removeChild(ta);
  setTimeout(function() {
    document.getElementById("copyFeedback").textContent = "";
  }, 2000);
}

// ===== CSVèª­ã¿è¾¼ã¿ =====
document.getElementById("loadCsvBtn").onclick = function() {
  fetch("jichi2507_rule.csv?t=" + Date.now())
    .then(function(res) {
      if (!res.ok) throw new Error("CSV not found");
      return res.text();
    })
    .then(function(csv) {
      parseCsv(csv);
      showStatus("CSVèª­ã¿è¾¼ã¿å®Œäº† (" + annotations.length + "ä»¶)", "success");
    })
    .catch(function(err) {
      showStatus("CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err.message, "error");
    });
};

function parseCsv(csv) {
  var lines = csv.trim().split("\n");
  annotations = [];

  for (var i = 1; i < lines.length; i++) {
    var line = lines[i];
    if (!line.trim()) continue;

    // CSVãƒ‘ãƒ¼ã‚¹ï¼ˆã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
    var cols = parseCsvLine(line);
    if (cols.length >= 5) {
      annotations.push({
        id: parseInt(cols[0]) || i,
        video_id: cols[1],
        start: parseFloat(cols[2]) || 0,
        end: parseFloat(cols[3]) || 0,
        query: cols[4]
      });
    }
  }

  renderTable();
}

function parseCsvLine(line) {
  var result = [];
  var current = "";
  var inQuotes = false;

  for (var i = 0; i < line.length; i++) {
    var c = line[i];
    if (c === '"') {
      inQuotes = !inQuotes;
    } else if (c === ',' && !inQuotes) {
      result.push(current);
      current = "";
    } else {
      current += c;
    }
  }
  result.push(current);
  return result;
}

// ===== CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ =====
document.getElementById("downloadCsvBtn").onclick = function() {
  var csv = "id,video_id,start,end,query\n";

  for (var i = 0; i < annotations.length; i++) {
    var a = annotations[i];
    var query = a.query.replace(/"/g, '""');
    csv += a.id + "," + a.video_id + "," + a.start.toFixed(1) + "," + a.end.toFixed(1) + ',"' + query + '"\n';
  }

  var blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  var url = URL.createObjectURL(blob);
  var link = document.createElement("a");
  link.href = url;
  link.download = "jichi2507_rule.csv";
  link.click();
  URL.revokeObjectURL(url);

  showStatus("CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ", "success");
};

// ===== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ =====
document.getElementById("restoreFromBackupBtn").onclick = function() {
  var backup = getBackupFromLocalStorage();
  if (!backup || !backup.annotations || backup.annotations.length === 0) {
    showStatus("å¾©å…ƒã§ãã‚‹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“", "error");
    return;
  }

  var timestamp = localStorage.getItem(BACKUP_TIMESTAMP_KEY) || "ä¸æ˜";
  if (confirm("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\n\nä¿å­˜æ—¥æ™‚: " + timestamp + "\nãƒ‡ãƒ¼ã‚¿æ•°: " + backup.annotations.length + "ä»¶\n\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚")) {
    restoreFromBackup();
  }
};

// ===== File System Access API: ãƒ­ãƒ¼ã‚«ãƒ«CSVã‚’é–‹ã =====
document.getElementById("openLocalCsvBtn").onclick = async function() {
  if (!window.showOpenFilePicker) {
    showStatus("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯File System Access APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ï¼ˆChrome/Edgeã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼‰", "error");
    return;
  }

  try {
    var [handle] = await window.showOpenFilePicker({
      types: [{
        description: "CSV Files",
        accept: { "text/csv": [".csv"] }
      }]
    });
    csvFileHandle = handle;

    var file = await handle.getFile();
    var csv = await file.text();
    parseCsv(csv);

    document.getElementById("saveCsvBtn").disabled = false;
    showStatus("ãƒ­ãƒ¼ã‚«ãƒ«CSVèª­ã¿è¾¼ã¿å®Œäº† (" + annotations.length + "ä»¶)", "success");

    // è‡ªå‹•ä¿å­˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤º
    var autoSaveStatus = document.getElementById("autoSaveStatus");
    autoSaveStatus.innerHTML = "ğŸ”„ <strong>è‡ªå‹•ä¿å­˜ON</strong>: å¤‰æ›´ã¯è‡ªå‹•çš„ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã•ã‚Œã¾ã™";
    autoSaveStatus.classList.add("active");
  } catch (err) {
    if (err.name !== "AbortError") {
      showStatus("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ: " + err.message, "error");
    }
  }
};

// ===== File System Access API: ä¸Šæ›¸ãä¿å­˜ =====
document.getElementById("saveCsvBtn").onclick = async function() {
  await saveToCsv(true);
};

// ===== CSVä¿å­˜é–¢æ•°ï¼ˆæ‰‹å‹•ãƒ»è‡ªå‹•å…±é€šï¼‰ =====
async function saveToCsv(showMessage) {
  if (!csvFileHandle) {
    if (showMessage) showStatus("å…ˆã«ãƒ­ãƒ¼ã‚«ãƒ«CSVã‚’é–‹ã„ã¦ãã ã•ã„", "error");
    return false;
  }

  try {
    var csv = "id,video_id,start,end,query\n";
    for (var i = 0; i < annotations.length; i++) {
      var a = annotations[i];
      var query = a.query.replace(/"/g, '""');
      csv += a.id + "," + a.video_id + "," + a.start.toFixed(1) + "," + a.end.toFixed(1) + ',"' + query + '"\n';
    }

    var writable = await csvFileHandle.createWritable();
    await writable.write(csv);
    await writable.close();

    if (showMessage) {
      showStatus("ä¸Šæ›¸ãä¿å­˜ã—ã¾ã—ãŸ", "success");
    } else {
      showAutoSaveIndicator();
    }
    return true;
  } catch (err) {
    showStatus("è‡ªå‹•ä¿å­˜ã«å¤±æ•—: " + err.message, "error");
    return false;
  }
}

// ===== è‡ªå‹•ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ =====
function showAutoSaveIndicator() {
  var indicator = document.getElementById("autoSaveIndicator");
  if (indicator) {
    indicator.textContent = "âœ“ è‡ªå‹•ä¿å­˜å®Œäº†";
    indicator.classList.add("show");
    setTimeout(function() {
      indicator.classList.remove("show");
    }, 2000);
  }
}

// ===== localStorageãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— =====
var BACKUP_KEY = "annotationBackup";
var BACKUP_TIMESTAMP_KEY = "annotationBackupTime";
var hasUnsavedChanges = false;

function saveToLocalStorage() {
  try {
    var backupData = {
      annotations: annotations,
      videoId: currentVideoId,
      timestamp: Date.now()
    };
    localStorage.setItem(BACKUP_KEY, JSON.stringify(backupData));
    localStorage.setItem(BACKUP_TIMESTAMP_KEY, new Date().toLocaleString("ja-JP"));
    return true;
  } catch (err) {
    console.error("localStorageãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¤±æ•—:", err);
    return false;
  }
}

function getBackupFromLocalStorage() {
  try {
    var data = localStorage.getItem(BACKUP_KEY);
    if (data) {
      return JSON.parse(data);
    }
  } catch (err) {
    console.error("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­ã¿è¾¼ã¿å¤±æ•—:", err);
  }
  return null;
}

function clearBackup() {
  localStorage.removeItem(BACKUP_KEY);
  localStorage.removeItem(BACKUP_TIMESTAMP_KEY);
}

function restoreFromBackup() {
  var backup = getBackupFromLocalStorage();
  if (backup && backup.annotations) {
    annotations = backup.annotations;
    if (backup.videoId) {
      currentVideoId = backup.videoId;
      document.getElementById("editVideoId").value = currentVideoId;
    }
    renderTable();
    showStatus("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ (" + annotations.length + "ä»¶)", "success");
    hasUnsavedChanges = true;
    updateBackupStatus();
    return true;
  }
  return false;
}

function updateBackupStatus() {
  var backupStatus = document.getElementById("backupStatus");
  var timestamp = localStorage.getItem(BACKUP_TIMESTAMP_KEY);
  if (backupStatus && timestamp) {
    backupStatus.textContent = "æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: " + timestamp;
    backupStatus.style.display = "block";
  }
}

// ===== è‡ªå‹•ä¿å­˜ã‚’å®Ÿè¡Œ =====
function autoSave() {
  // localStorageã«å¸¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  saveToLocalStorage();
  updateBackupStatus();

  // CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒé–‹ã‹ã‚Œã¦ã„ã‚Œã°ã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚‚ä¿å­˜
  if (csvFileHandle) {
    saveToCsv(false);
    hasUnsavedChanges = false;
  } else {
    hasUnsavedChanges = true;
  }
}

// ===== ãƒšãƒ¼ã‚¸é›¢è„±è­¦å‘Š =====
window.addEventListener("beforeunload", function(e) {
  // CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒé–‹ã‹ã‚Œã¦ã„ãªã„å ´åˆã®ã¿è­¦å‘Š
  if (hasUnsavedChanges && annotations.length > 0) {
    e.preventDefault();
    e.returnValue = "æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã¾ã™ã‹ï¼Ÿ";
    return e.returnValue;
  }
});

// ===== ä½œæ¥­ã‚¿ã‚¤ãƒãƒ¼ =====
var timerState = {
  running: false,
  startTime: 0,
  elapsedTime: 0,
  annotationCount: 0,
  intervalId: null
};

function formatTimerTime(ms) {
  var totalSeconds = Math.floor(ms / 1000);
  var hours = Math.floor(totalSeconds / 3600);
  var minutes = Math.floor((totalSeconds % 3600) / 60);
  var seconds = totalSeconds % 60;
  return String(hours).padStart(2, '0') + ':' +
         String(minutes).padStart(2, '0') + ':' +
         String(seconds).padStart(2, '0');
}

function formatTimerShort(ms) {
  var totalSeconds = Math.floor(ms / 1000);
  var minutes = Math.floor(totalSeconds / 60);
  var seconds = totalSeconds % 60;
  if (minutes >= 60) {
    var hours = Math.floor(minutes / 60);
    minutes = minutes % 60;
    return hours + ':' + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
  }
  return String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
}

function updateTimerDisplay() {
  var currentElapsed = timerState.elapsedTime;
  if (timerState.running) {
    currentElapsed += Date.now() - timerState.startTime;
  }

  // ãƒ¡ã‚¤ãƒ³è¡¨ç¤º
  document.getElementById('timerDisplay').textContent = formatTimerTime(currentElapsed);

  // çµŒéæ™‚é–“ï¼ˆçŸ­ç¸®å½¢ï¼‰
  document.getElementById('timerTotalTime').textContent = formatTimerShort(currentElapsed);

  // è¿½åŠ æ•°
  document.getElementById('timerCount').textContent = timerState.annotationCount;

  // ä»¶/æ™‚ï¼ˆ1æ™‚é–“ã‚ãŸã‚Šã®ä»¶æ•°ï¼‰
  if (currentElapsed > 0 && timerState.annotationCount > 0) {
    var hoursElapsed = currentElapsed / (1000 * 60 * 60);
    var rate = timerState.annotationCount / hoursElapsed;
    document.getElementById('timerRate').textContent = rate.toFixed(1);
  } else {
    document.getElementById('timerRate').textContent = '-';
  }

  // å¹³å‡æ™‚é–“
  if (timerState.annotationCount > 0) {
    var avgMs = currentElapsed / timerState.annotationCount;
    document.getElementById('timerAvg').textContent = formatTimerShort(avgMs);
    document.getElementById('timerAvgPanel').style.display = 'block';
  } else {
    document.getElementById('timerAvgPanel').style.display = 'none';
  }
}

function startTimer() {
  if (timerState.running) return;

  timerState.running = true;
  timerState.startTime = Date.now();

  document.getElementById('timerPanel').classList.add('running');
  document.getElementById('timerDisplay').classList.add('running');
  document.getElementById('timerStartBtn').disabled = true;
  document.getElementById('timerStartBtn').textContent = 'â–¶ è¨ˆæ¸¬ä¸­...';
  document.getElementById('timerStopBtn').disabled = false;

  timerState.intervalId = setInterval(updateTimerDisplay, 1000);
  updateTimerDisplay();
}

function stopTimer() {
  if (!timerState.running) return;

  timerState.elapsedTime += Date.now() - timerState.startTime;
  timerState.running = false;

  document.getElementById('timerPanel').classList.remove('running');
  document.getElementById('timerDisplay').classList.remove('running');
  document.getElementById('timerStartBtn').disabled = false;
  document.getElementById('timerStartBtn').textContent = 'â–¶ å†é–‹';
  document.getElementById('timerStopBtn').disabled = true;

  if (timerState.intervalId) {
    clearInterval(timerState.intervalId);
    timerState.intervalId = null;
  }
  updateTimerDisplay();
}

function resetTimer() {
  stopTimer();
  timerState.elapsedTime = 0;
  timerState.annotationCount = 0;
  timerState.startTime = 0;

  document.getElementById('timerStartBtn').textContent = 'â–¶ é–‹å§‹';
  updateTimerDisplay();
}

function incrementTimerCount() {
  if (timerState.running) {
    timerState.annotationCount++;
    updateTimerDisplay();
  }
}

// ã‚¿ã‚¤ãƒãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById('timerStartBtn').onclick = startTimer;
document.getElementById('timerStopBtn').onclick = stopTimer;
document.getElementById('timerResetBtn').onclick = function() {
  if (timerState.annotationCount > 0 || timerState.elapsedTime > 0) {
    if (confirm('ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nè¨˜éŒ²ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ã€‚')) {
      resetTimer();
    }
  } else {
    resetTimer();
  }
};

// ===== ãƒ†ãƒ¼ãƒ–ãƒ«æç”» =====
function renderTable() {
  var tbody = document.getElementById("annotationBody");
  tbody.innerHTML = "";

  for (var i = 0; i < annotations.length; i++) {
    var a = annotations[i];
    var tr = document.createElement("tr");
    tr.dataset.id = a.id;

    if (editingId === a.id) {
      tr.classList.add("editing");
    }

    tr.innerHTML =
      "<td>" + a.id + "</td>" +
      "<td>" + escapeHtml(a.video_id) + "</td>" +
      "<td>" + a.start.toFixed(1) + "</td>" +
      "<td>" + a.end.toFixed(1) + "</td>" +
      '<td class="query-cell" title="' + escapeHtml(a.query) + '">' + escapeHtml(a.query) + "</td>" +
      "<td>" +
        '<button class="btn-primary btn-small edit-btn" data-id="' + a.id + '">ç·¨é›†</button> ' +
        '<button class="btn-danger btn-small delete-btn" data-id="' + a.id + '">å‰Šé™¤</button>' +
      "</td>";

    tbody.appendChild(tr);
  }

  document.getElementById("annotationCount").textContent = annotations.length;

  // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  var editBtns = document.querySelectorAll(".edit-btn");
  for (var j = 0; j < editBtns.length; j++) {
    editBtns[j].onclick = function() {
      editAnnotation(parseInt(this.dataset.id));
    };
  }

  var deleteBtns = document.querySelectorAll(".delete-btn");
  for (var k = 0; k < deleteBtns.length; k++) {
    deleteBtns[k].onclick = function() {
      deleteAnnotation(parseInt(this.dataset.id));
    };
  }
}

function escapeHtml(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

// ===== ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç·¨é›† =====
function editAnnotation(id) {
  var a = annotations.find(function(x) { return x.id === id; });
  if (!a) return;

  editingId = id;
  document.getElementById("editId").value = id;
  document.getElementById("editVideoId").value = a.video_id;
  document.getElementById("editStart").value = a.start;
  document.getElementById("editEnd").value = a.end;
  document.getElementById("editQuery").value = a.query;

  document.getElementById("formTitle").textContent = "ç·¨é›†ä¸­: ID " + id;
  document.getElementById("saveBtn").textContent = "æ›´æ–°";

  renderTable();
}

// ===== ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å‰Šé™¤ =====
function deleteAnnotation(id) {
  if (!confirm("ID " + id + " ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  annotations = annotations.filter(function(x) { return x.id !== id; });

  if (editingId === id) {
    clearForm();
  }

  renderTable();
  showStatus("ID " + id + " ã‚’å‰Šé™¤ã—ã¾ã—ãŸ", "success");
  autoSave(); // è‡ªå‹•ä¿å­˜
}

// ===== ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢ =====
function clearForm() {
  editingId = null;
  document.getElementById("editId").value = "";
  document.getElementById("editVideoId").value = currentVideoId;
  document.getElementById("editStart").value = "";
  document.getElementById("editEnd").value = "";
  document.getElementById("editQuery").value = "";

  document.getElementById("formTitle").textContent = "æ–°è¦ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³";
  document.getElementById("saveBtn").textContent = "è¿½åŠ ";

  renderTable();
}

document.getElementById("clearFormBtn").onclick = clearForm;

// ===== ä¿å­˜ =====
document.getElementById("saveBtn").onclick = function() {
  var videoId = document.getElementById("editVideoId").value.trim();
  var start = parseFloat(document.getElementById("editStart").value) || 0;
  var end = parseFloat(document.getElementById("editEnd").value) || 0;
  var query = document.getElementById("editQuery").value.trim();

  if (!videoId) {
    showStatus("å‹•ç”»ã‚’é¸æŠã—ã¦ãã ã•ã„", "error");
    return;
  }

  if (editingId !== null) {
    // æ›´æ–°
    var a = annotations.find(function(x) { return x.id === editingId; });
    if (a) {
      a.video_id = videoId;
      a.start = start;
      a.end = end;
      a.query = query;
      showStatus("ID " + editingId + " ã‚’æ›´æ–°ã—ã¾ã—ãŸ", "success");
    }
  } else {
    // æ–°è¦è¿½åŠ 
    var maxId = 0;
    for (var i = 0; i < annotations.length; i++) {
      if (annotations[i].id > maxId) maxId = annotations[i].id;
    }

    annotations.push({
      id: maxId + 1,
      video_id: videoId,
      start: start,
      end: end,
      query: query
    });
    showStatus("ID " + (maxId + 1) + " ã‚’è¿½åŠ ã—ã¾ã—ãŸ", "success");
    incrementTimerCount(); // ã‚¿ã‚¤ãƒãƒ¼ã‚«ã‚¦ãƒ³ãƒˆå¢—åŠ 
  }

  clearForm();
  autoSave(); // è‡ªå‹•ä¿å­˜
};

// ===== ç¾åœ¨æ™‚åˆ»ã‚»ãƒƒãƒˆ =====
document.getElementById("setStartBtn").onclick = function() {
  document.getElementById("editStart").value = formatTimeForCopy(v.currentTime);
};

document.getElementById("setEndBtn").onclick = function() {
  document.getElementById("editEnd").value = formatTimeForCopy(v.currentTime);
};

// ===== ã‚ªãƒ¼ãƒˆã‚µã‚¸ã‚§ã‚¹ãƒˆ =====
var queryInput = document.getElementById("editQuery");
var suggestionsBox = document.getElementById("suggestions");
var selectedIndex = -1;

function getUniqueQueries() {
  var seen = {};
  var unique = [];
  for (var i = 0; i < annotations.length; i++) {
    var q = annotations[i].query;
    if (q && !seen[q]) {
      seen[q] = true;
      unique.push(q);
    }
  }
  return unique.sort();
}

function showSuggestions(input) {
  var queries = getUniqueQueries();
  var inputLower = input.toLowerCase();
  var matches = [];

  if (input.length > 0) {
    for (var i = 0; i < queries.length; i++) {
      if (queries[i].toLowerCase().indexOf(inputLower) !== -1) {
        matches.push(queries[i]);
      }
    }
  }

  suggestionsBox.innerHTML = "";
  selectedIndex = -1;

  if (matches.length === 0) {
    suggestionsBox.classList.remove("show");
    return;
  }

  for (var j = 0; j < matches.length && j < 10; j++) {
    var div = document.createElement("div");
    div.className = "suggestion-item";
    div.textContent = matches[j];
    div.dataset.query = matches[j];
    div.onclick = function() {
      queryInput.value = this.dataset.query;
      suggestionsBox.classList.remove("show");
    };
    suggestionsBox.appendChild(div);
  }

  suggestionsBox.classList.add("show");
}

queryInput.addEventListener("input", function() {
  showSuggestions(this.value);
});

queryInput.addEventListener("focus", function() {
  if (this.value.length > 0) {
    showSuggestions(this.value);
  }
});

queryInput.addEventListener("keydown", function(e) {
  var items = suggestionsBox.querySelectorAll(".suggestion-item");
  if (items.length === 0) return;

  if (e.key === "ArrowDown") {
    e.preventDefault();
    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
    updateSelection(items);
  } else if (e.key === "ArrowUp") {
    e.preventDefault();
    selectedIndex = Math.max(selectedIndex - 1, -1);
    updateSelection(items);
  } else if (e.key === "Enter" && selectedIndex >= 0) {
    e.preventDefault();
    queryInput.value = items[selectedIndex].dataset.query;
    suggestionsBox.classList.remove("show");
  } else if (e.key === "Escape") {
    suggestionsBox.classList.remove("show");
  }
});

function updateSelection(items) {
  for (var i = 0; i < items.length; i++) {
    items[i].classList.remove("selected");
  }
  if (selectedIndex >= 0 && selectedIndex < items.length) {
    items[selectedIndex].classList.add("selected");
    items[selectedIndex].scrollIntoView({ block: "nearest" });
  }
}

document.addEventListener("click", function(e) {
  if (!suggestionsBox.contains(e.target) && e.target !== queryInput) {
    suggestionsBox.classList.remove("show");
  }
});

// ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º =====
function showStatus(msg, type) {
  var el = document.getElementById("status");
  el.textContent = msg;
  el.className = type || "";

  setTimeout(function() {
    el.textContent = "";
    el.className = "";
  }, 3000);
}

// ===== åˆæœŸåŒ–: CSVè‡ªå‹•èª­ã¿è¾¼ã¿ =====
window.onload = function() {
  // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ç¢ºèª
  var backup = getBackupFromLocalStorage();
  var backupTimestamp = localStorage.getItem(BACKUP_TIMESTAMP_KEY);

  if (backup && backup.annotations && backup.annotations.length > 0) {
    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚‹å ´åˆã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    var backupInfo = document.getElementById("backupInfo");
    backupInfo.innerHTML = "<strong>" + backup.annotations.length + "ä»¶</strong>ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³<br>ä¿å­˜æ—¥æ™‚: " + backupTimestamp;

    document.getElementById("backupModal").classList.add("show");

    document.getElementById("restoreBackupBtn").onclick = function() {
      restoreFromBackup();
      document.getElementById("backupModal").classList.remove("show");
    };

    document.getElementById("ignoreBackupBtn").onclick = function() {
      document.getElementById("backupModal").classList.remove("show");
      clearBackup();
      // CSVã‚’èª­ã¿è¾¼ã‚€
      loadCsvFromServer();
    };
  } else {
    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒãªã„å ´åˆã€é€šå¸¸é€šã‚ŠCSVã‚’èª­ã¿è¾¼ã‚€
    loadCsvFromServer();
  }

  updateBackupStatus();
};

function loadCsvFromServer() {
  fetch("jichi2507_rule.csv?t=" + Date.now())
    .then(function(res) {
      if (!res.ok) throw new Error("CSV not found");
      return res.text();
    })
    .then(function(csv) {
      parseCsv(csv);
      showStatus("CSVè‡ªå‹•èª­ã¿è¾¼ã¿å®Œäº† (" + annotations.length + "ä»¶)", "success");
    })
    .catch(function(err) {
      showStatus("CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚", "error");
    });
}

// ===== ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ =====
document.getElementById("shortcutHelpBtn").onclick = function() {
  document.getElementById("shortcutModal").classList.add("show");
};

document.getElementById("shortcutModal").onclick = function(e) {
  if (e.target === this) {
    this.classList.remove("show");
  }
};

// å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
// ã‚¤ãƒ³ã‚µãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¯ã‚¨ãƒªå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼‰
var insertMode = false;

function isInputFocused() {
  var el = document.activeElement;
  if (!el) return false;
  // ã‚¯ã‚¨ãƒªãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã¿è¨±å¯
  return el.id === "editQuery";
}

function enterInsertMode() {
  insertMode = true;
  var queryInput = document.getElementById("editQuery");
  queryInput.focus();
  updateInsertModeIndicator();
}

function exitInsertMode() {
  insertMode = false;
  document.getElementById("editQuery").blur();
  document.activeElement.blur();
  updateInsertModeIndicator();
}

function updateInsertModeIndicator() {
  var indicator = document.getElementById("insertModeIndicator");
  if (insertMode) {
    indicator.classList.add("active");
    indicator.textContent = "ğŸ“ INSERT MODE (Escã§çµ‚äº†)";
  } else {
    indicator.classList.remove("active");
    indicator.textContent = "[I] ã§å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰";
  }
}

// ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ãƒšãƒ¼ã‚¹ãƒˆ
async function pasteToQuery() {
  try {
    var text = await navigator.clipboard.readText();
    var queryInput = document.getElementById("editQuery");

    // ç¾åœ¨ã®ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«æŒ¿å…¥ã€ã¾ãŸã¯ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã„ãªã‘ã‚Œã°æœ«å°¾ã«è¿½åŠ 
    if (document.activeElement === queryInput) {
      var start = queryInput.selectionStart;
      var end = queryInput.selectionEnd;
      var current = queryInput.value;
      queryInput.value = current.substring(0, start) + text + current.substring(end);
      queryInput.selectionStart = queryInput.selectionEnd = start + text.length;
    } else {
      queryInput.value += text;
    }

    showStatus("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ãƒšãƒ¼ã‚¹ãƒˆã—ã¾ã—ãŸ", "success");
  } catch (err) {
    showStatus("ãƒšãƒ¼ã‚¹ãƒˆå¤±æ•—: ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ", "error");
  }
}

// å…¨ã¦ã®ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å¾Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã™
document.addEventListener("click", function(e) {
  var target = e.target;
  if (target.tagName === "BUTTON" || target.tagName === "INPUT" && target.type !== "text" && target.type !== "number" && target.id !== "editQuery") {
    // ã‚¯ã‚¨ãƒªä»¥å¤–ã®å…¥åŠ›è¦ç´ ã‚„ãƒœã‚¿ãƒ³ã¯ã‚¯ãƒªãƒƒã‚¯å¾Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã™
    setTimeout(function() {
      if (document.activeElement && document.activeElement.id !== "editQuery") {
        document.activeElement.blur();
      }
    }, 10);
  }
});

// ã‚¯ã‚¨ãƒªãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹/ãƒ–ãƒ©ãƒ¼ã§ã‚¤ãƒ³ã‚µãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
document.getElementById("editQuery").addEventListener("focus", function() {
  insertMode = true;
  updateInsertModeIndicator();
});

document.getElementById("editQuery").addEventListener("blur", function() {
  insertMode = false;
  updateInsertModeIndicator();
});

// Escapeã§ã‚¤ãƒ³ã‚µãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰çµ‚äº†
document.getElementById("editQuery").addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    e.preventDefault();
    exitInsertMode();
  }
});

// ãƒšãƒ¼ã‚¹ãƒˆãƒœã‚¿ãƒ³
document.getElementById("pasteBtn").onclick = function() {
  pasteToQuery();
  this.blur();
};

document.addEventListener("keydown", function(e) {
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯Escã§é–‰ã˜ã‚‹
  var modal = document.getElementById("shortcutModal");
  if (modal.classList.contains("show")) {
    if (e.key === "Escape") {
      modal.classList.remove("show");
    }
    return;
  }

  // Ctrl+S: æ‰‹å‹•ä¿å­˜
  if (e.ctrlKey && e.key === "s") {
    e.preventDefault();
    saveToCsv(true);
    return;
  }

  // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã¯ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç„¡åŠ¹
  if (isInputFocused()) return;

  var key = e.key.toLowerCase();

  switch (key) {
    // å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
    case " ": // Space: å†ç”Ÿ/ä¸€æ™‚åœæ­¢
      e.preventDefault();
      document.getElementById("btnPlayPause").click();
      break;
    case "r": // R: å·»ãæˆ»ã—
      e.preventDefault();
      document.getElementById("btnRewind").click();
      break;
    case "f": // F: æ—©é€ã‚Š
      e.preventDefault();
      document.getElementById("btnFastFwd").click();
      break;
    case "m": // M: ãƒŸãƒ¥ãƒ¼ãƒˆ
      e.preventDefault();
      document.getElementById("muteBtn").click();
      break;
    case "arrowup": // â†‘: éŸ³é‡+10%
      e.preventDefault();
      adjustVolume(10);
      break;
    case "arrowdown": // â†“: éŸ³é‡-10%
      e.preventDefault();
      adjustVolume(-10);
      break;
    case "[": // [: éŸ³é‡-10%
      e.preventDefault();
      adjustVolume(-10);
      break;
    case "]": // ]: éŸ³é‡+10%
      e.preventDefault();
      adjustVolume(10);
      break;

    // ã‚·ãƒ¼ã‚¯
    case "j": // J: -10ç§’
      e.preventDefault();
      seekBy(-10);
      break;
    case "l": // L: +10ç§’
      e.preventDefault();
      seekBy(10);
      break;
    case "arrowleft": // â†: -1ç§’
      e.preventDefault();
      seekBy(-1);
      break;
    case "arrowright": // â†’: +1ç§’
      e.preventDefault();
      seekBy(1);
      break;
    case ",": // ,: -0.1ç§’
      e.preventDefault();
      seekBy(-0.1);
      break;
    case ".": // .: +0.1ç§’
      e.preventDefault();
      seekBy(0.1);
      break;

    // ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
    case "s": // S: Startæ™‚åˆ»ã‚»ãƒƒãƒˆ
      e.preventDefault();
      document.getElementById("setStartBtn").click();
      break;
    case "e": // E: Endæ™‚åˆ»ã‚»ãƒƒãƒˆ
      e.preventDefault();
      document.getElementById("setEndBtn").click();
      break;
    case "c": // C: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚³ãƒ”ãƒ¼
      e.preventDefault();
      document.getElementById("timestampBtn").click();
      break;
    case "p": // P: ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰
      e.preventDefault();
      document.getElementById("fineModeBtn").click();
      break;

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ•ã‚©ãƒ¼ãƒ æ“ä½œ
    case "o": // O: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
      e.preventDefault();
      document.getElementById("file").click();
      break;
    case "enter": // Enter: ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ /æ›´æ–°
      e.preventDefault();
      document.getElementById("saveBtn").click();
      break;
    case "i": // I: ã‚¤ãƒ³ã‚µãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¯ã‚¨ãƒªå…¥åŠ›ï¼‰
      e.preventDefault();
      enterInsertMode();
      break;
    case "v": // V: ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ãƒšãƒ¼ã‚¹ãƒˆ
      e.preventDefault();
      pasteToQuery();
      break;

    // ã‚¿ã‚¤ãƒãƒ¼æ“ä½œ
    case "t": // T: ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹/åœæ­¢ãƒˆã‚°ãƒ«
      e.preventDefault();
      if (timerState.running) {
        stopTimer();
      } else {
        startTimer();
      }
      break;
    case "y": // Y: ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
      e.preventDefault();
      if (timerState.annotationCount > 0 || timerState.elapsedTime > 0) {
        if (confirm('ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          resetTimer();
        }
      }
      break;

    // ãƒ˜ãƒ«ãƒ—
    case "?": // ?: ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒ˜ãƒ«ãƒ—
      e.preventDefault();
      document.getElementById("shortcutModal").classList.add("show");
      break;
  }
});

// ===== ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ =====
(function() {
  var resizeHandle = document.getElementById("resizeHandle");
  var leftColumn = document.getElementById("leftColumn");
  var rightColumn = document.getElementById("rightColumn");
  var mainGrid = document.getElementById("mainGrid");

  if (!resizeHandle || !leftColumn || !rightColumn || !mainGrid) return;

  var isDragging = false;
  var startX = 0;
  var startLeftWidth = 0;

  // ä¿å­˜ã•ã‚ŒãŸå¹…ã‚’å¾©å…ƒ
  var savedLeftWidth = localStorage.getItem("columnLeftWidth");
  if (savedLeftWidth && window.innerWidth >= 1024) {
    var percent = parseFloat(savedLeftWidth);
    if (percent >= 20 && percent <= 80) {
      leftColumn.style.flex = "0 0 " + percent + "%";
      rightColumn.style.flex = "0 0 " + (100 - percent - 2) + "%";
    }
  }

  function onMouseDown(e) {
    if (window.innerWidth < 1024) return;

    isDragging = true;
    startX = e.clientX || e.touches[0].clientX;
    startLeftWidth = leftColumn.offsetWidth;

    resizeHandle.classList.add("dragging");
    document.body.style.cursor = "col-resize";
    document.body.style.userSelect = "none";

    e.preventDefault();
  }

  function onMouseMove(e) {
    if (!isDragging) return;

    var clientX = e.clientX || (e.touches && e.touches[0].clientX);
    if (!clientX) return;

    var delta = clientX - startX;
    var containerWidth = mainGrid.offsetWidth;
    var newLeftWidth = startLeftWidth + delta;

    // æœ€å°ãƒ»æœ€å¤§å¹…ã®åˆ¶é™ï¼ˆ20%ã€œ80%ï¼‰
    var minWidth = containerWidth * 0.2;
    var maxWidth = containerWidth * 0.8;

    if (newLeftWidth < minWidth) newLeftWidth = minWidth;
    if (newLeftWidth > maxWidth) newLeftWidth = maxWidth;

    var leftPercent = (newLeftWidth / containerWidth) * 100;
    var rightPercent = 100 - leftPercent - 2; // 2% for handle and gaps

    leftColumn.style.flex = "0 0 " + leftPercent + "%";
    rightColumn.style.flex = "0 0 " + rightPercent + "%";
  }

  function onMouseUp() {
    if (!isDragging) return;

    isDragging = false;
    resizeHandle.classList.remove("dragging");
    document.body.style.cursor = "";
    document.body.style.userSelect = "";

    // å¹…ã‚’ä¿å­˜
    var containerWidth = mainGrid.offsetWidth;
    var leftPercent = (leftColumn.offsetWidth / containerWidth) * 100;
    localStorage.setItem("columnLeftWidth", leftPercent.toFixed(1));
  }

  // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
  resizeHandle.addEventListener("mousedown", onMouseDown);
  document.addEventListener("mousemove", onMouseMove);
  document.addEventListener("mouseup", onMouseUp);

  // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
  resizeHandle.addEventListener("touchstart", onMouseDown, { passive: false });
  document.addEventListener("touchmove", onMouseMove, { passive: false });
  document.addEventListener("touchend", onMouseUp);

  // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«ãƒªã‚»ãƒƒãƒˆ
  var resizeTimeout;
  window.addEventListener("resize", function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
      if (window.innerWidth < 1024) {
        leftColumn.style.flex = "";
        rightColumn.style.flex = "";
      } else {
        // ä¿å­˜ã•ã‚ŒãŸå¹…ã‚’å†é©ç”¨
        var saved = localStorage.getItem("columnLeftWidth");
        if (saved) {
          var percent = parseFloat(saved);
          if (percent >= 20 && percent <= 80) {
            leftColumn.style.flex = "0 0 " + percent + "%";
            rightColumn.style.flex = "0 0 " + (100 - percent - 2) + "%";
          }
        }
      }
    }, 100);
  });
})();
</script>

</div>
</body>
</html>
